name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Circom
        run: |
          wget https://github.com/iden3/circom/releases/download/v2.2.3/circom-linux-amd64
          chmod +x circom-linux-amd64
          sudo mv circom-linux-amd64 /usr/local/bin/circom
          circom --version

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Build artifacts information
        run: |
          echo "‚ÑπÔ∏è  Rust/Substrate Integration"
          echo ""
          echo "The .zkey file works directly with ark-circom (Rust library):"
          echo "  https://github.com/arkworks-rs/circom-compat"
          echo ""
          echo "Example usage:"
          echo "  use ark_circom::read_zkey;"
          echo "  let (pk, matrices) = read_zkey(&mut zkey_file)?;"
          echo "  let proof = Groth16::<Bn254>::prove(&pk, circuit, &mut rng)?;"
          echo ""
          echo "No .ark conversion needed!"

      - name: Install dependencies
        run: npm ci

      - name: Build all circuits
        run: npm run build-all

      - name: Convert .zkey to .ark format
        run: |
          echo "üîÑ Converting all .zkey files to .ark format using Rust script..."
        
        # Install nightly Rust with script support
        rustup toolchain install nightly --profile minimal
        rustup component add rust-src --toolchain nightly
        
        echo ""
        echo "Converting disclosure circuit..."
        cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
          keys/disclosure_pk.zkey \
          keys/disclosure_pk.ark
        
        echo ""
        echo "Converting transfer circuit..."
        cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
          keys/transfer_pk.zkey \
          keys/transfer_pk.ark
        
        echo ""
        echo "Converting unshield circuit..."
        cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
          keys/unshield_pk.zkey \
          keys/unshield_pk.ark
        
        echo ""
        echo "‚úì All conversions complete"
        echo ""
        echo "Generated .ark files:"
        ls -lh keys/*_pk.ark
          echo "Verifying generated artifacts for all circuits..."
          echo ""
          echo "=== Disclosure Circuit ==="
          ls -lh build/disclosure_js/disclosure.wasm && echo "‚úì WASM file present"
          ls -lh build/verification_key_disclosure.json && echo "‚úì Verification key present"
          ls -lh keys/disclosure_pk.zkey && echo "‚úì Proving key (.zkey) present"
          ls -lh keys/disclosure_pk.ark && echo "‚úì Arkworks key (.ark) present"

          echo ""
          echo "=== Transfer Circuit ==="
          ls -lh build/transfer_js/transfer.wasm && echo "‚úì WASM file present"
          ls -lh build/verification_key_transfer.json && echo "‚úì Verification key present"
          ls -lh keys/transfer_pk.zkey && echo "‚úì Proving key (.zkey) present"
          ls -lh keys/transfer_pk.ark && echo "‚úì Arkworks key (.ark) present"

          echo ""
          echo "=== Unshield Circuit ==="
          ls -lh build/unshield_js/unshield.wasm && echo "‚úì WASM file present"
          ls -lh build/verification_key_unshield.json && echo "‚úì Verification key present"
          ls -lh keys/unshield_pk.zkey && echo "‚úì Proving key (.zkey) present"
          ls -lh keys/unshield_pk.ark && echo "‚úì Arkworks key (.ark) present"

          echo ""
          echo "‚úì All 12 required files present for release (4 files √ó 3 circuits)"
          echo ""
          echo "Files available:"
          echo "  - .wasm ‚Üí Witness calculator"
          echo "  - .json ‚Üí Verification keys"
          echo "  - .zkey ‚Üí snarkjs (JavaScript/TypeScript)"
          echo "  - .ark  ‚Üí arkworks (Rust/Substrate, optimized)"

      - name: Generate checksums
        run: |
          mkdir -p release
          cd build

          # Disclosure
          sha256sum disclosure_js/disclosure.wasm > ../release/checksums.txt
          sha256sum verification_key_disclosure.json >> ../release/checksums.txt

          # Transfer
          sha256sum transfer_js/transfer.wasm >> ../release/checksums.txt
          sha256sum verification_key_transfer.json >> ../release/checksums.txt

          # Unshield
          sha256sum unshield_js/unshield.wasm >> ../release/checksums.txt
          sha256sum verification_key_unshield.json >> ../release/checksums.txt

          cd ../keys

          # All zkey and ark files
          sha256sum disclosure_pk.zkey >> ../release/checksums.txt
          sha256sum disclosure_pk.ark >> ../release/checksums.txt
          sha256sum transfer_pk.zkey >> ../release/checksums.txt
          sha256sum transfer_pk.ark >> ../release/checksums.txt
          sha256sum unshield_pk.zkey >> ../release/checksums.txt
          sha256sum unshield_pk.ark >> ../release/checksums.txt

          cd ../release
          echo "Generated checksums for all 12 files:"
          cat checksums.txt

      - name: Package artifacts
        run: |
          VERSION=${{ github.ref_name }}

          # Create temporary directories for packaging
          mkdir -p release/arkworks-temp
          mkdir -p release/snarkjs-temp
          mkdir -p release/verification-keys-temp

          echo "üì¶ Preparing release assets..."

          # Asset 1: .wasm and .ark files for arkworks/Rust (at root, no nested directories)
          echo ""
          echo "1Ô∏è‚É£  Copying arkworks files (.wasm, .ark)..."
          cp build/disclosure_js/disclosure.wasm release/arkworks-temp/
          cp build/transfer_js/transfer.wasm release/arkworks-temp/
          cp build/unshield_js/unshield.wasm release/arkworks-temp/
          cp keys/disclosure_pk.ark release/arkworks-temp/
          cp keys/transfer_pk.ark release/arkworks-temp/
          cp keys/unshield_pk.ark release/arkworks-temp/

          # Create tarball of arkworks files (all at root)
          cd release/arkworks-temp
          tar -czf ../orbinum-circuits-${VERSION}.tar.gz *
          cd ../..

          echo "‚úÖ Asset 1 created: orbinum-circuits-${VERSION}.tar.gz"
          echo "   Contents (6 files at root - .wasm + .ark):"
          tar -tzf release/orbinum-circuits-${VERSION}.tar.gz
          echo ""

          # Asset 2: .zkey files for snarkjs/JavaScript (at root, no nested directories)
          echo "2Ô∏è‚É£  Copying snarkjs files (.zkey)..."
          cp keys/disclosure_pk.zkey release/snarkjs-temp/
          cp keys/transfer_pk.zkey release/snarkjs-temp/
          cp keys/unshield_pk.zkey release/snarkjs-temp/

          # Create tarball of snarkjs files (all at root)
          cd release/snarkjs-temp
          tar -czf ../orbinum-circuits-snarkjs-${VERSION}.tar.gz *
          cd ../..

          echo "‚úÖ Asset 2 created: orbinum-circuits-snarkjs-${VERSION}.tar.gz"
          echo "   Contents (3 files at root - .zkey):"
          tar -tzf release/orbinum-circuits-snarkjs-${VERSION}.tar.gz
          echo ""

          # Asset 3: All verification keys JSON (at root, no nested directories)
          echo "3Ô∏è‚É£  Copying verification keys (JSON)..."
          cp build/verification_key_disclosure.json release/verification-keys-temp/
          cp build/verification_key_transfer.json release/verification-keys-temp/
          cp build/verification_key_unshield.json release/verification-keys-temp/

          # Create tarball of verification keys (all at root)
          cd release/verification-keys-temp
          tar -czf ../orbinum-verification-keys-${VERSION}.tar.gz *
          cd ../..

          echo "‚úÖ Asset 3 created: orbinum-verification-keys-${VERSION}.tar.gz"
          echo "   Contents (3 files at root - .json):"
          tar -tzf release/orbinum-verification-keys-${VERSION}.tar.gz
          echo ""

          # Copy checksums
          cp release/checksums.txt release/checksums-${VERSION}.txt

          echo "üì¶ Assets summary:"
          ls -lh release/*.tar.gz release/checksums-${VERSION}.txt
          echo ""
          echo "‚úÖ All 3 assets ready for release"

      - name: Create release notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Extract changelog section
          sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$ d' > release_notes.md

          # Add integration instructions
          cat >> release_notes.md << 'EOFNOTES'

          ## üì¶ Release Assets

          This release includes **3 compressed archives**:

          ### 1. `orbinum-circuits-{version}.tar.gz` (Arkworks - ~22 MB)
          Contains files for **Rust/arkworks proof generation**:
          - `disclosure.wasm`, `transfer.wasm`, `unshield.wasm` - Witness calculators
          - `disclosure_pk.ark`, `transfer_pk.ark`, `unshield_pk.ark` - Proving keys (arkworks format)

          **Total: 6 files at root** (no nested directories)

          ### 2. `orbinum-circuits-snarkjs-{version}.tar.gz` (snarkjs - ~24 MB)
          Contains files for **JavaScript/TypeScript proof generation**:
          - `disclosure_pk.zkey`, `transfer_pk.zkey`, `unshield_pk.zkey` - Proving keys (snarkjs format)

          **Total: 3 files at root** (no nested directories)  
          **Note:** You still need the `.wasm` files from Asset 1 to use snarkjs

          ### 3. `orbinum-verification-keys-{version}.tar.gz` (VKs - ~10 KB)
          Contains **verification keys** for on-chain validation:
          - `verification_key_disclosure.json`
          - `verification_key_transfer.json`
          - `verification_key_unshield.json`

          **Total: 3 files at root** (no nested directories)

          ## üöÄ Included Circuits

          - **Disclosure Circuit**: Selective revelation of note fields (1,584 constraints)
          - **Transfer Circuit**: Private token transfers with EdDSA signatures (41,212 constraints)
          - **Unshield Circuit**: Convert private notes to public tokens (11,718 constraints)

          ## üîó Integration Examples

          ### JavaScript/TypeScript (snarkjs)
          ```bash
          # Download both arkworks (for .wasm) and snarkjs (for .zkey)
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-{version}.tar.gz
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-snarkjs-{version}.tar.gz
          tar -xzf orbinum-circuits-{version}.tar.gz
          tar -xzf orbinum-circuits-snarkjs-{version}.tar.gz
          ```

          ```typescript
          import { groth16 } from 'snarkjs';

          // Generate proof with transfer circuit
          const { proof, publicSignals } = await groth16.fullProve(
            inputs,
            'transfer.wasm',           // From orbinum-circuits-{version}.tar.gz
            'transfer_pk.zkey'          // From orbinum-circuits-snarkjs-{version}.tar.gz
          );
          ```

          ### Rust/Substrate (arkworks + optimized .ark file)
          ```bash
          # Download arkworks files only (.wasm + .ark)
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-{version}.tar.gz
          tar -xzf orbinum-circuits-{version}.tar.gz
          ```

          ```rust
          use ark_bn254::Bn254;
          use ark_groth16::{Groth16, ProvingKey};
          use ark_serialize::CanonicalDeserialize;
          use std::fs::File;

          // Load pre-serialized .ark file (2-3x faster)
          let mut ark_file = File::open("transfer_pk.ark")?;
          let proving_key = ProvingKey::<Bn254>::deserialize_compressed(&mut ark_file)?;

          // Generate proof
          let proof = Groth16::<Bn254>::prove(&proving_key, circuit, &mut rng)?;
          ```

          ### Substrate Runtime (on-chain verification)
          ```bash
          # Download verification keys
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-verification-keys-{version}.tar.gz
          tar -xzf orbinum-verification-keys-{version}.tar.gz
          ```

          The JSON verification keys are registered in the runtime using `pallet-zk-verifier`.

          ## üìä File Sizes

          | Circuit | WASM | .ark | .zkey | VK (JSON) |
          |---------|------|------|-------|-----------|
          | Disclosure | ~200 KB | ~600 KB | 689 KB | 3.4 KB |
          | Transfer | ~400 KB | ~17 MB | 19 MB | 3.6 KB |
          | Unshield | ~250 KB | ~4.5 MB | 5.1 MB | 3.6 KB |

          **Asset 1 (arkworks):** ~22 MB compressed (.wasm + .ark)  
          **Asset 2 (snarkjs):** ~24 MB compressed (.zkey)  
          **Asset 3 (verification keys):** ~10 KB compressed (.json)

          ## ‚ö†Ô∏è Security Notice

          These keys are generated with a **development setup** for testing purposes only.

          **Production deployment requires:**
          - Multi-party trusted setup ceremony (50+ independent contributors)
          - Hardware security modules (HSMs) for key contributors
          - Public verification of ceremony transcripts

          ## üì• Quick Download

          ```bash
          # For Rust/arkworks proof generation
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-{version}.tar.gz
          tar -xzf orbinum-circuits-{version}.tar.gz

          # For JavaScript/snarkjs proof generation (needs both)
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-{version}.tar.gz
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-circuits-snarkjs-{version}.tar.gz
          tar -xzf orbinum-circuits-{version}.tar.gz
          tar -xzf orbinum-circuits-snarkjs-{version}.tar.gz

          # For on-chain verification (runtime)
          wget https://github.com/orbinum/circuits/releases/download/{version}/orbinum-verification-keys-{version}.tar.gz
          tar -xzf orbinum-verification-keys-{version}.tar.gz
          ```
          EOFNOTES

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/orbinum-circuits-*.tar.gz
            release/orbinum-circuits-snarkjs-*.tar.gz
            release/orbinum-verification-keys-*.tar.gz
            release/checksums-*.txt
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Announce release
        run: |
          echo "üéâ Release ${{ github.ref_name }} published!"
          echo "Download artifacts from: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
