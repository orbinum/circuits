name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install Circom
      run: |
        wget https://github.com/iden3/circom/releases/download/v2.2.3/circom-linux-amd64
        chmod +x circom-linux-amd64
        sudo mv circom-linux-amd64 /usr/local/bin/circom
        circom --version
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    
    - name: Build artifacts information
      run: |
        echo "‚ÑπÔ∏è  Rust/Substrate Integration"
        echo ""
        echo "The .zkey file works directly with ark-circom (Rust library):"
        echo "  https://github.com/arkworks-rs/circom-compat"
        echo ""
        echo "Example usage:"
        echo "  use ark_circom::read_zkey;"
        echo "  let (pk, matrices) = read_zkey(&mut zkey_file)?;"
        echo "  let proof = Groth16::<Bn254>::prove(&pk, circuit, &mut rng)?;"
        echo ""
        echo "No .ark conversion needed!"
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build all circuits
      run: npm run build-all
    
    - name: Convert .zkey to .ark format
      run: |
        echo "üîÑ Converting .zkey to .ark using Rust script..."
        rustup toolchain install nightly
        cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
          keys/disclosure_pk.zkey \
          keys/disclosure_pk.ark
        
        echo ""
        echo "‚úì Conversion complete"
        ls -lh keys/disclosure_pk.*
    
    - name: Verify build artifacts
      run: |
        echo "Verifying generated artifacts..."
        echo ""
        echo "Circuit files:"
        ls -lh build/disclosure_js/disclosure.wasm && echo "‚úì WASM file present"
        ls -lh build/verification_key_disclosure.json && echo "‚úì Verification key present"
        ls -lh keys/disclosure_pk.zkey && echo "‚úì Proving key (.zkey) present"
        ls -lh keys/disclosure_pk.ark && echo "‚úì Arkworks key (.ark) present"
        echo ""
        echo "‚úì All required files present for release"
        echo ""
        echo "Files available:"
        echo "  - .zkey ‚Üí snarkjs (JavaScript/TypeScript)"
        echo "  - .ark  ‚Üí arkworks (Rust/Substrate, optimized)"

    
    - name: Generate checksums
      run: |
        mkdir -p release
        cd build
        sha256sum disclosure_js/disclosure.wasm > ../release/checksums.txt
        sha256sum verification_key_disclosure.json >> ../release/checksums.txt
        cd ../keys
        sha256sum disclosure_pk.zkey >> ../release/checksums.txt
        sha256sum disclosure_pk.ark >> ../release/checksums.txt
        cd ../release
        cat checksums.txt
    
    - name: Package artifacts
      run: |
        VERSION=${{ github.ref_name }}
        
        echo "Creating circuit package..."
        tar -czf release/disclosure-circuit-${VERSION}.tar.gz \
          build/disclosure_js/disclosure.wasm \
          keys/disclosure_pk.zkey \
          keys/disclosure_pk.ark \
          build/verification_key_disclosure.json \
          release/checksums.txt
        
        echo "‚úì Created disclosure-circuit-${VERSION}.tar.gz"
        ls -lh release/disclosure-circuit-${VERSION}.tar.gz
        echo ""
        echo "Package includes:"
        echo "  ‚úì disclosure.wasm (witness calculator)"
        echo "  ‚úì disclosure_pk.zkey (snarkjs proving key)"
        echo "  ‚úì disclosure_pk.ark (arkworks proving key)"
        echo "  ‚úì verification_key_disclosure.json (verifier key)"
        echo "  ‚úì checksums.txt (SHA256 checksums)"
    
    - name: Create release notes
      id: release_notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Extract changelog section
        sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$ d' > release_notes.md
        
        # Add integration instructions
        cat >> release_notes.md << 'EOFNOTES'
        
        ## Integration
        
        ### JavaScript/TypeScript (snarkjs)
        ```typescript
        import { groth16 } from 'snarkjs';
        
        const { proof, publicSignals } = await groth16.fullProve(
          inputs,
          'disclosure.wasm',
          'disclosure_pk.zkey'  // Use .zkey file
        );
        ```
        
        ### Rust/Substrate (arkworks) - Option 1: .ark file (optimized)
        ```rust
        use ark_bn254::Bn254;
        use ark_groth16::{Groth16, ProvingKey};
        use ark_serialize::CanonicalDeserialize;
        use std::fs::File;
        
        // Load pre-serialized .ark file (faster)
        let mut ark_file = File::open("disclosure_pk.ark")?;
        let proving_key = ProvingKey::<Bn254>::deserialize_compressed(&mut ark_file)?;
        
        // Generate proof
        let proof = Groth16::<Bn254>::prove(&proving_key, circuit, &mut rng)?;
        ```
        
        ### Rust/Substrate (arkworks) - Option 2: .zkey file (direct)
        ```rust
        use ark_circom::read_zkey;
        use ark_bn254::Bn254;
        use ark_groth16::Groth16;
        
        // Read .zkey file directly (requires ark-circom)
        let mut zkey_file = File::open("disclosure_pk.zkey")?;
        let (proving_key, matrices) = read_zkey(&mut zkey_file)?;
        
        // Generate proof
        let proof = Groth16::<Bn254>::prove(&proving_key, circuit, &mut rng)?;
        ```
        
        **Dependencies:**
        - Rust (Option 1): `ark-bn254 = "0.5.0"`, `ark-groth16 = "0.5.0"`, `ark-serialize = "0.5.0"`
        - Rust (Option 2): `ark-circom = "0.5.0"`
        - Repository: https://github.com/arkworks-rs/circom-compat
        
        **Performance:** `.ark` file loads ~2-3x faster than `.zkey` (no parsing overhead)
        EOFNOTES

    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.tar.gz
          release/checksums.txt
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Announce release
      run: |
        echo "üéâ Release ${{ github.ref_name }} published!"
        echo "Download artifacts from: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
