name: Release

on:
    push:
        branches: [main]
        paths:
            - "package.json"
            - "CHANGELOG.md"
            - "circuits/**"
            - "scripts/**"
            - "npm/**"
            - "Makefile"
            - ".github/workflows/release.yml"

permissions:
    contents: write

jobs:
    release:
        name: Build, Release, and Publish
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Extract version from package.json
              id: version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$VERSION" >> $GITHUB_OUTPUT
                  echo "üì¶ Version: $VERSION"

            - name: Check if tag already exists
              id: check_tag
              run: |
                  if git rev-parse "refs/tags/v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.version }} already exists. Skipping release."
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "‚úÖ Tag v${{ steps.version.outputs.version }} does not exist, proceeding"
                  fi

            - name: Install Circom
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  wget https://github.com/iden3/circom/releases/download/v2.2.3/circom-linux-amd64
                  chmod +x circom-linux-amd64
                  sudo mv circom-linux-amd64 /usr/local/bin/circom
                  circom --version

            - name: Setup Rust
              if: steps.check_tag.outputs.exists == 'false'
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Install dependencies
              if: steps.check_tag.outputs.exists == 'false'
              run: npm ci

            - name: Build all circuits
              if: steps.check_tag.outputs.exists == 'false'
              run: npm run build-all

            - name: Convert .zkey to .ark format
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  echo "üîÑ Converting all .zkey files to .ark format using Rust script..."

                  rustup toolchain install nightly --profile minimal
                  rustup component add rust-src --toolchain nightly

                  cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
                    keys/disclosure_pk.zkey \
                    keys/disclosure_pk.ark

                  cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
                    keys/transfer_pk.zkey \
                    keys/transfer_pk.ark

                  cargo +nightly -Zscript scripts/build/convert-to-ark.rs \
                    keys/unshield_pk.zkey \
                    keys/unshield_pk.ark

                  echo "‚úì All conversions complete"
                  ls -lh keys/*_pk.ark

            - name: Generate checksums
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  mkdir -p release
                  cd build

                  sha256sum disclosure_js/disclosure.wasm > ../release/checksums.txt
                  sha256sum verification_key_disclosure.json >> ../release/checksums.txt
                  sha256sum transfer_js/transfer.wasm >> ../release/checksums.txt
                  sha256sum verification_key_transfer.json >> ../release/checksums.txt
                  sha256sum unshield_js/unshield.wasm >> ../release/checksums.txt
                  sha256sum verification_key_unshield.json >> ../release/checksums.txt

                  cd ../keys
                  sha256sum disclosure_pk.zkey >> ../release/checksums.txt
                  sha256sum disclosure_pk.ark >> ../release/checksums.txt
                  sha256sum transfer_pk.zkey >> ../release/checksums.txt
                  sha256sum transfer_pk.ark >> ../release/checksums.txt
                  sha256sum unshield_pk.zkey >> ../release/checksums.txt
                  sha256sum unshield_pk.ark >> ../release/checksums.txt

            - name: Package artifacts
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.version.outputs.tag }}

                  mkdir -p release/arkworks-temp
                  mkdir -p release/snarkjs-temp
                  mkdir -p release/verification-keys-temp

                  cp build/disclosure_js/disclosure.wasm release/arkworks-temp/
                  cp build/transfer_js/transfer.wasm release/arkworks-temp/
                  cp build/unshield_js/unshield.wasm release/arkworks-temp/
                  cp keys/disclosure_pk.ark release/arkworks-temp/
                  cp keys/transfer_pk.ark release/arkworks-temp/
                  cp keys/unshield_pk.ark release/arkworks-temp/

                  cd release/arkworks-temp
                  tar -czf ../orbinum-circuits-${VERSION}.tar.gz *
                  cd ../..

                  cp keys/disclosure_pk.zkey release/snarkjs-temp/
                  cp keys/transfer_pk.zkey release/snarkjs-temp/
                  cp keys/unshield_pk.zkey release/snarkjs-temp/

                  cd release/snarkjs-temp
                  tar -czf ../orbinum-circuits-snarkjs-${VERSION}.tar.gz *
                  cd ../..

                  cp build/verification_key_disclosure.json release/verification-keys-temp/
                  cp build/verification_key_transfer.json release/verification-keys-temp/
                  cp build/verification_key_unshield.json release/verification-keys-temp/

                  cd release/verification-keys-temp
                  tar -czf ../orbinum-verification-keys-${VERSION}.tar.gz *
                  cd ../..

                  mv release/checksums.txt release/checksums-${VERSION}.txt

                  ls -lh release/*.tar.gz release/checksums-${VERSION}.txt

            - name: Create release notes
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.version.outputs.version }}

                  awk '/^## \[Unreleased\]/{flag=1;next}/^## \[/{if(flag){exit}}flag' CHANGELOG.md > release_unreleased.md

                  {
                    echo "## ${{ steps.version.outputs.tag }}"
                    echo ""
                    if [ -s release_unreleased.md ]; then
                      cat release_unreleased.md
                    else
                      echo "- Release generated from CI."
                    fi
                    echo ""
                    echo "## Release Assets"
                    echo ""
                    echo "- orbinum-circuits-${{ steps.version.outputs.tag }}.tar.gz (.wasm + .ark)"
                    echo "- orbinum-circuits-snarkjs-${{ steps.version.outputs.tag }}.tar.gz (.zkey)"
                    echo "- orbinum-verification-keys-${{ steps.version.outputs.tag }}.tar.gz (.json)"
                  } > release_notes.md

            - name: Create and push tag
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
                  git push origin "${{ steps.version.outputs.tag }}"

            - name: Create GitHub Release
              if: steps.check_tag.outputs.exists == 'false'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  files: |
                      release/*.tar.gz
                      release/*.txt
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
                  fail_on_unmatched_files: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Prepare npm package
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  mkdir -p pkg

                  cp build/disclosure_js/disclosure.wasm pkg/
                  cp build/transfer_js/transfer.wasm pkg/
                  cp build/unshield_js/unshield.wasm pkg/

                  cp keys/disclosure_pk.zkey pkg/
                  cp keys/transfer_pk.zkey pkg/
                  cp keys/unshield_pk.zkey pkg/

                  cp keys/disclosure_pk.ark pkg/
                  cp keys/transfer_pk.ark pkg/
                  cp keys/unshield_pk.ark pkg/

                  cp build/verification_key_disclosure.json pkg/
                  cp build/verification_key_transfer.json pkg/
                  cp build/verification_key_unshield.json pkg/

                  cp npm/README.md pkg/
                  cp npm/index.js pkg/
                  cp npm/index.d.ts pkg/
                  cp LICENSE pkg/

                  cat npm/package.json.template | sed "s/\"version\": \".*\"/\"version\": \"${VERSION}\"/" > pkg/package.json

            - name: Setup Node.js for npm publish
              if: steps.check_tag.outputs.exists == 'false'
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  registry-url: "https://registry.npmjs.org"

            - name: Publish to npm
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  cd pkg
                  VERSION=${{ steps.version.outputs.version }}
                  if npm view @orbinum/circuits@$VERSION version >/dev/null 2>&1; then
                    echo "‚ö†Ô∏è Version $VERSION already published on npm. Skipping publish."
                  else
                    npm publish
                  fi
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Upload to Cloudflare R2
              if: steps.check_tag.outputs.exists == 'false'
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
                  AWS_DEFAULT_REGION: auto
                  AWS_ENDPOINT_URL: https://${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com
              run: |
                  echo "‚òÅÔ∏è Syncing artifacts to Cloudflare R2 (v1)..."
                  ls -la pkg/ || echo "pkg/ not found"
                  # Sync pkg directory to v1 folder in bucket
                  aws s3 sync pkg s3://circuits/v1/ --endpoint-url $AWS_ENDPOINT_URL --no-progress
                  echo "‚úÖ Upload complete"
