name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install Circom
      run: |
        wget https://github.com/iden3/circom/releases/download/v2.2.3/circom-linux-amd64
        chmod +x circom-linux-amd64
        sudo mv circom-linux-amd64 /usr/local/bin/circom
        circom --version
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    
    - name: Cache ark-circom
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/ark-circom
        key: ${{ runner.os }}-ark-circom-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-ark-circom-
    
    - name: Install ark-circom
      run: |
        if ! command -v ark-circom &> /dev/null; then
          echo "Installing ark-circom from release..."
          
          # Download and extract the release
          cd /tmp
          wget https://github.com/arkworks-rs/circom-compat/archive/refs/tags/v0.5.0-alpha.tar.gz
          tar -xzf v0.5.0-alpha.tar.gz
          cd circom-compat-0.5.0-alpha
          
          # Build the ark-circom binary
          cargo build --release
          
          # Find and install the binary
          find target/release -maxdepth 1 -type f -executable -name "ark-circom" -o -name "circom-compat"
          
          if [ -f target/release/ark-circom ]; then
            mkdir -p ~/.cargo/bin
            cp target/release/ark-circom ~/.cargo/bin/
            chmod +x ~/.cargo/bin/ark-circom
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
            echo "âœ“ ark-circom installed successfully"
            ark-circom --version || echo "Binary installed but version check failed"
          else
            echo "âš  No binary found after build"
            echo "Available binaries:"
            ls -la target/release/ | grep -E "^-rwx"
            echo "Release will continue with JavaScript package only"
          fi
        else
          echo "âœ“ ark-circom already installed"
          ark-circom --version
        fi
      continue-on-error: true
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build all circuits
      run: npm run build-all
    
    - name: Convert to Arkworks format (.ark)
      run: |
        if command -v ark-circom &> /dev/null; then
          echo "Converting .zkey to .ark format..."
          npm run convert:disclosure || {
            echo "âš  .ark conversion failed, but continuing with release"
            echo "JavaScript package will still be created"
            exit 0
          }
          
          if [ -f keys/disclosure_pk.ark ]; then
            echo "âœ“ .ark file generated successfully"
            ls -lh keys/disclosure_pk.ark
          else
            echo "âš  .ark file not found after conversion"
          fi
        else
          echo "âš  ark-circom not available, skipping .ark generation"
          echo "Only JavaScript package will be created"
        fi
    
    - name: Verify build artifacts
      run: |
        echo "Verifying generated artifacts..."
        echo ""
        echo "Required files (JavaScript/TypeScript):"
        ls -lh build/disclosure_js/disclosure.wasm && echo "âœ“ WASM file present"
        ls -lh build/verification_key_disclosure.json && echo "âœ“ Verification key present"
        ls -lh keys/disclosure_pk.zkey && echo "âœ“ Proving key (.zkey) present"
        
        echo ""
        echo "Optional files (Rust/Arkworks):"
        if [ -f keys/disclosure_pk.ark ]; then
          ls -lh keys/disclosure_pk.ark && echo "âœ“ Arkworks key (.ark) present"
          echo "âœ“ Both JavaScript and Rust packages will be created"
        else
          echo "âš  .ark file not found"
          echo "â„¹ Only JavaScript package will be created"
        fi
    
    - name: Generate checksums
      run: |
        mkdir -p release
        cd build
        sha256sum disclosure_js/disclosure.wasm > ../release/checksums-js.txt
        sha256sum verification_key_disclosure.json >> ../release/checksums-js.txt
        cd ../keys
        sha256sum disclosure_pk.zkey >> ../release/checksums-js.txt
        
        # Generate Rust checksums if .ark exists
        if [ -f disclosure_pk.ark ]; then
          sha256sum disclosure_pk.ark > ../release/checksums-rust.txt
          cat ../release/checksums-js.txt | grep -v ".zkey" >> ../release/checksums-rust.txt
          echo "âœ“ Generated checksums for both JS and Rust packages"
        else
          echo "âš  Skipping Rust checksums (.ark not available)"
        fi
    
    - name: Package artifacts
      run: |
        VERSION=${{ github.ref_name }}
        
        # JavaScript/TypeScript package (always generated)
        echo "Creating JavaScript package..."
        tar -czf release/disclosure-circuit-js-${VERSION}.tar.gz \
          build/disclosure_js/disclosure.wasm \
          keys/disclosure_pk.zkey \
          build/verification_key_disclosure.json \
          release/checksums-js.txt
        
        echo "âœ“ Created disclosure-circuit-js-${VERSION}.tar.gz"
        ls -lh release/disclosure-circuit-js-${VERSION}.tar.gz
        
        # Rust/Arkworks package (conditional)
        if [ -f keys/disclosure_pk.ark ]; then
          echo "Creating Rust package..."
          tar -czf release/disclosure-circuit-rust-${VERSION}.tar.gz \
            build/disclosure_js/disclosure.wasm \
            keys/disclosure_pk.ark \
            build/verification_key_disclosure.json \
            release/checksums-rust.txt
          
          echo "âœ“ Created disclosure-circuit-rust-${VERSION}.tar.gz"
          ls -lh release/disclosure-circuit-rust-${VERSION}.tar.gz
        else
          echo "âš  Skipping Rust package (.ark file not available)"
          echo "JavaScript package still created successfully."
        fi
    
    - name: Extract changelog
      id: changelog
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$ d' > release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.tar.gz
          release/checksums-*.txt
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Announce release
      run: |
        echo "ðŸŽ‰ Release ${{ github.ref_name }} published!"
        echo "Download artifacts from: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
